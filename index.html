<head>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css"
        integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
        integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
        integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js"
        integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6"
        crossorigin="anonymous"></script>
    <script src='https://cdn.plot.ly/plotly-latest.min.js'></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>
    <script>
        var countryList = ["Turkey", "Italy", "China"];
        var data = {
            "Turkey": { text: "Turkey", startDate: new Date(2020, 2, 11), data: { totalCase: [1, 1, 5, 5, 18, 47, 98, 191, 359, 670, 947], totalDeath: [0, 0, 0, 0, 0, 0, 0, 5, 8, 10, 12], newCase: [1, 0, 4, 0, 13, 29, 90, 200, 400, 300], newDeath: [0, 0, 0, 0, 0, 0, 0, 5, 3, 2, 2] } },
            "Italy":  { text: "Italy",  startDate: new Date(2020, 1, 22), data: { totalCase: [19, 30, 50, 90, 180, 470, 980, 1910, 2000, 4000, 9470], totalDeath: [0, 10, 30, 50, 100, 300, 400, 500, 800, 1000, 1500], newCase: [10, 30, 40, 100, 300, 290, 50, 200, 4000, 3000], newDeath: [10, 10, 10, 100, 200, 300, 400, 500, 300, 200, 1000] } },
            "China":  { text: "China",  startDate: new Date(2020, 0, 22), data: { totalCase: [190, 300, 500, 900, 1800, 4700, 9800, 19100, 20000, 40000, 94700], totalDeath: [10, 20, 100, 300, 400, 500, 600, 700, 800, 1030, 12000], newCase: [100, 50, 40, 30, 130, 290, 900, 2000, 4000, 800], newDeath: [10, 0, 10, 1000, 0, 2000, 100, 500, 300, 2200, 2500] } },
        }
        var displayingData = [];
        var dateCount = 10;
        var mergeOrigin = false;
        $(document).ready(function () {
            main();
        });
        colorPalette = ["rgb(255, 0, 0)", "rgb(153, 0, 0)", "rgb(0, 255, 0)", "rgb(0, 102, 51)"];



        function main() {
            $('#countries').select2({
                data: countryList,
                maximumSelectionLength: 2,
            });
            $('#countries').on('select2:close', function (e) {
                DisplayGraph();
            });
            $('#countries').val('Turkey').trigger('change'); // Notify any JS components that the value changed
            $("#mergeOrigin").change(function () {
                if (this.checked == false) {
                    $("#dateCount").prop('disabled', true);
                }
                else {
                    $("#dateCount").prop('disabled', false);
                }
                mergeOrigin = this.checked;
                DisplayGraph();
            });
            $("#dateCount").change(function () {
                if (this.value < 10) {
                    this.value = 10;
                }
                dateCount = parseInt(this.value);
                DisplayGraph();
            });
            DisplayGraph();
        }

        function GetCountryGraphData(country, colorIndex) {
            var country_graph = [];
            var data_x = [];
            var sampleCount = country.data.totalCase.length;
            if (mergeOrigin == true) {
                sampleCount = dateCount < sampleCount ? dateCount : sampleCount;
                for (var i = 1; i <= sampleCount; i++) {
                    data_x.push(i);
                }
            }
            else {
                for (var i = 0; i < sampleCount; i++) {
                    var newDate = new Date(country.startDate);
                    newDate.setDate(country.startDate.getDate() + i);
                    data_x.push(newDate);
                }
            }
            country_graph.push(
                {
                    name: country.text + " - Total Case",
                    visible: "legendonly",
                    type: 'scatter',
                    marker: {
                        color: colorPalette[colorIndex],
                    },
                    x: data_x,
                    y: country.data.totalCase.slice(0, sampleCount)
                }
            );
            country_graph.push(
                {
                    name: country.text + " - Total Death",
                    visible: "legendonly",
                    type: 'scatter',
                    marker: {
                        color: colorPalette[colorIndex + 1],
                    },
                    x: data_x,
                    y: country.data.totalDeath.slice(0, sampleCount)
                }
            );
            country_graph.push(
                {
                    name: country.text + " - New Case",
                    type: 'bar',
                    marker: {
                        color: colorPalette[colorIndex],
                    },
                    x: data_x,
                    y: country.data.newCase.slice(0, sampleCount)
                }
            );
            country_graph.push(
                {
                    name: country.text + " - New Death",
                    type: 'bar',
                    marker: {
                        color: colorPalette[colorIndex + 1],
                    },
                    x: data_x,
                    y: country.data.newDeath.slice(0, sampleCount)
                }
            );
            return country_graph;
        }

        function CreateGraphData() {
            var result = [];
            displayingData = [];
            $('#countries').select2('data').forEach(element => {
                displayingData.push(data[element.text]);
            });
            var colorIndex = 0;
            displayingData.forEach(country => {
                debugger;
                result = result.concat(GetCountryGraphData(country, colorIndex));
                colorIndex += 2;
            });
            return result;
        }

        function DisplayGraph() {
            var graph_data = CreateGraphData();
            var layout = {
                title: 'COVID 19',
                xaxis: {
                    tickformat: '%d.%m.%y',
                    title: {
                        text: "Date"
                    }
                },
                yaxis: {
                    title: {
                        text: "Person"
                    }
                }
            };
            if (mergeOrigin == true)
            {
                delete layout.xaxis.tickformat
            }

            Plotly.newPlot('totalGraph', graph_data, layout);
        }
    </script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-161528453-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'UA-161528453-1');
    </script>
</head>

<body>
    <form>
        <div class="form-group">
            <select id="countries" class="countries col-md-7" multiple="multiple">
            </select>
            <input type="number" class="form-number-input col-md-1" id="dateCount" value="10" disabled=true>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <input type="checkbox" class="form-check-input" id="mergeOrigin">
            <label class="form-check-label col-md-2" for="exampleCheck1">Merge Origin</label>
        </div>
        <div class="form-group form-check">

        </div>
        <div class="form-group form-check">

        </div>


    </form>

    <input type="checkbox" class="form-check-input" id="mergeOrigin">
    <div id='totalGraph'>
    </div>
    <div id='percentageGraph'>
    </div>

</body>
